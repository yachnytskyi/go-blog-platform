name: Deploy Docker Image

on:
  workflow_call:
    inputs:
      docker_username:
        required: true
        type: string
      docker_password:
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # Step 1: Check out the repository.
    - name: Checkout Code
      uses: actions/checkout@v4

    # Step 2: Set up Go.
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: stable

    # Step 3: Log in to DockerHub
    - name: Log in to DockerHub
      uses: docker/login-action@v2
      with:
        username: ${{ inputs.docker_username }}
        password: ${{ inputs.docker_password }}

    # Step 4: Determine Version Tag.
    - name: Determine Version Tag
      id: version
      run: |
        git fetch --tags
        LATEST_TAG=$(git tag -l --sort=-v:refname | head -n 1)

        if [ -z "$LATEST_TAG" ]; then
          VERSION="1.0.0"
        else
          VERSION="$LATEST_TAG"
        fi

        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "Version Tag: $VERSION"

    # Step 5: Build and Push Docker Image for app-develop
    - name: Build and Push Docker Image for app-develop
      run: |
        docker buildx build \
          --file infrastructure/deployment/docker/Dockerfile.develop \
          --tag ${{ inputs.docker_username }}/app-develop:${{ env.VERSION }} \
          --tag ${{ inputs.docker_username }}/app-develop:latest \
          --cache-from type=registry,ref=${{ inputs.docker_username }}/app-develop:latest \
          --push .
